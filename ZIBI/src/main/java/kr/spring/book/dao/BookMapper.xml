<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.spring.book.dao.BookMapper">
	<!-- 소모임 예약 게시글 등록 -->		
	<insert id="insertBook" parameterType="bookVO">
		INSERT INTO book(
			book_num,
			mem_num,
			book_thumbnailName,
			book_category,
			book_title,
			book_content,
			book_gatheringDate,
			book_match,
			book_address1,
			book_address2,
			book_kit,
			book_maxcount,
			book_ip,
			book_expense)
		VALUES (
			book_seq.nextval,
			#{mem_num},
			#{book_thumbnailName,jdbcType=VARCHAR},
			#{book_category},
			#{book_title},
			#{book_content},
			#{book_gatheringDate},
			#{book_match},
			#{book_address1},
			#{book_address2},
			#{book_kit,jdbcType=VARCHAR},
			#{book_maxcount},
			#{book_ip},
			#{book_expense,jdbcType=VARCHAR}
		)
	</insert>
	
	<!-- 검색 -->
	<sql id="bookSearch">
		<where>
			<if test="keyword != null and keyword != ''">
				<if test="keyfield == 1">
					book_title LIKE '%' || #{keyword} || '%'
				</if>
				<if test="keyfield == 2">
					mem_nickname LIKE '%' || #{keyword} || '%'
				</if>
			</if>
		</where>
	</sql>
	
	<!-- 정렬 -->
	<sql id="bookOrder">
		<if test="order == 1">
			ORDER BY book_regDate DESC
		</if>
		<if test="order == 2">
			ORDER BY rev_cnt DESC
		</if>
		<if test="order == 3">
			ORDER BY scrap_cnt DESC
		</if>
	</sql>
	
	<!-- 소모임 예약 게시글의 총 개수/검색 개수 -->
	<select id="selectRowCount" parameterType="map" resultType="integer">
		SELECT
			COUNT(*)
		FROM book 
		LEFT OUTER JOIN member USING(mem_num) 
		LEFT OUTER JOIN member_detail USING(mem_num)
		<include refid="bookSearch"></include>
	</select>
	
	<!-- 소모임 예약 게시글 전체 목록/검색 목록 -->
	<select id="selectList" parameterType="map" resultType="bookVO">
		SELECT
			*
		FROM (SELECT
				a.*,
				rownum rnum
			FROM (SELECT
					book_num,
					mem_num,
					<![CDATA[
					REPLACE(REPLACE(book_title,'<','&lt;'),'>','&gt;') book_title,
					]]>
					book_thumbnailName,
					book_category,
					book_onoff,
					book_regDate,
					book_address1,
					book_kit,
					book_maxcount,
					book_headcount,
					book_expense,
					mem_nickname
				FROM book
				LEFT OUTER JOIN member USING(mem_num)
				<include refid="bookSearch"></include> 
				<include refid="bookOrder"></include>)a)
		<![CDATA[
		WHERE rnum >= #{start} AND rnum <= #{end}
		]]>	
	</select>
	
	<!-- 소모임 나의 예약 내역 개수 -->
	<select id="selectMatchCount" parameterType="map" resultType="integer">
		SELECT
			COUNT(*)
		FROM book_matching
		JOIN book USING(book_num)
		WHERE mem_num=#{mem_num} OR apply_num=#{mem_num}
	</select>
	
	<!-- 소모임 나의 예약 내역 -->
	<select id="selectMatchList" parameterType="map" resultType="bookVO">
		SELECT
			*
		FROM (SELECT
				a.*,
				rownum rnum
			FROM (SELECT
					book_num,
					mem_num,
					apply_num,
					<![CDATA[
					REPLACE(REPLACE(book_title,'<','&lt;'),'>','&gt;') book_title,
					]]>
					book_onoff,
					book_regDate,
					book_gatheringDate,
					<![CDATA[
					CASE WHEN SYSDATE >= TO_DATE(book_gatheringDate,'YYYY-MM-DD HH24:MI') THEN '1'
                       	 WHEN SYSDATE < TO_DATE(book_gatheringDate,'YYYY-MM-DD HH24:MI') THEN '2'
                  	END compareNow,
                  	]]>
					book_address1,
					book_state,
					book_match,
					book_matchDate
				FROM book_matching
				JOIN book USING(book_num)
				WHERE mem_num=#{mem_num} OR apply_num=#{mem_num}
				ORDER BY book_matchDate DESC)a)
		<![CDATA[
		WHERE rnum >= #{mstart} AND rnum <= #{mend}
		]]>
		
	</select>
	
	<!-- 소모임 예약 상세글 -->
	<select id="selectBook" parameterType="integer" resultType="bookVO">
		SELECT
			book_num,
			mem_num,
			book_category,
			book_thumbnailName,
			book_match,
			book_title,
			book_headcount,
			book_maxcount,
			book_expense,
			book_onoff,
			book_content,
			book_address1,
			book_address2,
			book_gatheringDate,
			<![CDATA[
			CASE WHEN SYSDATE >= TO_DATE(book_gatheringDate,'YYYY-MM-DD HH24:MI') THEN '1'
                 WHEN SYSDATE < TO_DATE(book_gatheringDate,'YYYY-MM-DD HH24:MI') THEN '2'
            END compareNow,
            ]]>
            book_kit,
            mem_nickname
		FROM book
		JOIN member USING(mem_num) 
		WHERE book_num=#{book_num}
	</select>
	
	<!-- 소모임 예약 글 수정 -->
	<update id="updateBook" parameterType="bookVO">
		UPDATE book SET
			<if test="book_thumbnailName != null">
			book_thumbnailName=#{book_thumbnailName},
			</if>
			book_category=#{book_category},
			book_title=#{book_title},
			book_content=#{book_content},
			book_gatheringDate=#{book_gatheringDate},
			book_match=#{book_match},
			book_address1=#{book_address1},
			book_address2=#{book_address2},
			book_kit=#{book_kit,jdbcType=VARCHAR},
			book_maxcount=#{book_maxcount},
			book_ip=#{book_ip},
			book_expense=#{book_expense,jdbcType=VARCHAR},
			book_modifydate=sysdate
		WHERE book_num=${book_num}
	</update>
</mapper>